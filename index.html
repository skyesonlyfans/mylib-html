<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900 text-white">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyLib</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .hidden { display: none; }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
        }
        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
        }
        .ebook-reader-content {
             -webkit-overflow-scrolling: touch;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            background-color: #2ecc71;
            color: white;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translate(-50%, 20px);
        }
        .toast.show {
            opacity: 1;
            transform: translate(-50%, 0);
        }
        /* Custom scrollbar for ebook reader */
        .ebook-reader-content::-webkit-scrollbar {
            width: 8px;
        }
        .ebook-reader-content::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .ebook-reader-content::-webkit-scrollbar-thumb {
            background-color: #718096;
            border-radius: 4px;
            border: 2px solid #2d3748;
        }
    </style>
</head>
<body class="h-full">
    <!-- Login Screen -->
    <div id="login-screen" class="flex flex-col items-center justify-center min-h-screen bg-gray-900 text-white p-4">
        <div class="text-center">
            <h1 class="text-5xl font-bold mb-2 text-indigo-400">MyLib</h1>
            <p class="text-lg text-gray-400 mb-8">Your personal, private library.</p>
            <button id="login-button" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                Sign In with Google
            </button>
            <p class="text-xs text-gray-500 mt-8">Access is by invitation only. Please contact the administrator if you believe you should have access.</p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="hidden h-full">
        <div class="flex flex-col h-full">
            <!-- Header -->
            <header class="bg-gray-800/80 backdrop-blur-sm shadow-md sticky top-0 z-50">
                <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <div class="flex items-center">
                            <span class="text-2xl font-bold text-indigo-400">MyLib</span>
                        </div>
                        <div class="hidden md:block">
                            <div class="ml-10 flex items-baseline space-x-4">
                                <a href="#" class="nav-link text-white bg-gray-900 px-3 py-2 rounded-md text-sm font-medium" data-page="library">Library</a>
                                <a href="#" class="nav-link text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium" data-page="shelf">My Shelf</a>
                                <a href="#" class="nav-link text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium" data-page="request">Request a Book</a>
                            </div>
                        </div>
                         <div class="flex items-center">
                            <button id="logout-button" class="ml-4 bg-red-600 hover:bg-red-500 text-white font-medium py-2 px-4 rounded-lg text-sm transition duration-300">Logout</button>
                        </div>
                         <div class="-mr-2 flex md:hidden">
                            <button id="mobile-menu-button" type="button" class="bg-gray-800 inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white" aria-controls="mobile-menu" aria-expanded="false">
                                <span class="sr-only">Open main menu</span>
                                <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                                </svg>
                                <svg class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </nav>
                 <!-- Mobile menu, show/hide based on menu state. -->
                <div class="md:hidden hidden" id="mobile-menu">
                    <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                        <a href="#" class="nav-link text-white bg-gray-900 block px-3 py-2 rounded-md text-base font-medium" data-page="library">Library</a>
                        <a href="#" class="nav-link text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium" data-page="shelf">My Shelf</a>
                        <a href="#" class="nav-link text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium" data-page="request">Request a Book</a>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="flex-1 overflow-y-auto bg-gray-900">
                <div id="library-page" class="page container mx-auto p-4 sm:p-6 lg:p-8">
                    <h2 class="text-3xl font-bold mb-6">Library</h2>
                    <div id="library-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                        <!-- Book items will be injected here -->
                    </div>
                </div>

                <div id="shelf-page" class="page hidden container mx-auto p-4 sm:p-6 lg:p-8">
                    <h2 class="text-3xl font-bold mb-6">My Shelf</h2>
                    <div id="shelf-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                        <!-- Shelf items will be injected here -->
                    </div>
                     <div id="empty-shelf-message" class="hidden text-center text-gray-400 mt-10">
                        <p>Your shelf is empty.</p>
                        <p>Browse the library to add books.</p>
                    </div>
                </div>

                <div id="request-page" class="page hidden container mx-auto p-4 sm:p-6 lg:p-8">
                    <div class="max-w-xl mx-auto">
                        <h2 class="text-3xl font-bold mb-6">Request a Book</h2>
                        <p class="text-gray-400 mb-6">Can't find what you're looking for? Fill out the form below and we'll do our best to add it to the library.</p>
                        <form id="request-form" class="space-y-4">
                            <div>
                                <label for="request-email" class="block text-sm font-medium text-gray-300">Your Email</label>
                                <input type="email" id="request-email" required class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="request-title" class="block text-sm font-medium text-gray-300">Book Title</label>
                                <input type="text" id="request-title" required class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="request-author" class="block text-sm font-medium text-gray-300">Author</label>
                                <input type="text" id="request-author" required class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="request-type" class="block text-sm font-medium text-gray-300">Type</label>
                                <select id="request-type" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option>E-Book</option>
                                    <option>Audiobook</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Submit Request</button>
                        </form>
                    </div>
                </div>
            </main>

            <!-- Footer -->
            <footer class="bg-gray-800/80">
                <div class="container mx-auto py-4 px-4 sm:px-6 lg:px-8 text-center text-gray-400 text-sm">
                    <p>Developed with &hearts; by Skye</p>
                </div>
            </footer>
        </div>
    </div>
    
    <!-- Modals and Overlays -->
    <div id="modal-container" class="hidden"></div>
    <div id="toast-container" class="toast"></div>


    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setDoc, getDoc, doc, collection, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDKIvS7CLmQrjwSMNWdyn0t9-KilK5cWGc",
            authDomain: "mylib-8c1ff.firebaseapp.com",
            projectId: "mylib-8c1ff",
            storageBucket: "mylib-8c1ff.appspot.com",
            messagingSenderId: "848663047778",
            appId: "1:848663047778:web:055ce1ea52031f5cdeeb3b",
            measurementId: "G-M73PRYR6H9"
        };
        
        // Backblaze B2 public bucket URL.
        // NOTE: For a real application, using signed URLs generated by a backend is more secure.
        // For this demo, we assume the bucket files are publicly readable.
        const B2_BUCKET_URL = 'https://s3.us-east-005.backblazeb2.com/mylibaudio/';

        // --- MOCK DATA ---
        // This catalog would typically come from a database.
        const libraryCatalog = [
            {
                id: 'dune_ebook',
                title: 'Dune',
                author: 'Frank Herbert',
                type: 'E-Book',
                cover: 'https://placehold.co/300x450/1a202c/7a8ba0?text=Dune',
                path: 'ebook_content/dune.html', // Path to a simple HTML file with book content
            },
            {
                id: 'the_shining_audio',
                title: 'The Shining',
                author: 'Stephen King',
                type: 'Audiobook',
                cover: 'https://placehold.co/300x450/1a202c/7a8ba0?text=The+Shining',
                path: 'audio_content/sample_audio.mp3', // Placeholder audio
            },
            {
                id: 'moby_dick_ebook',
                title: 'Moby Dick',
                author: 'Herman Melville',
                type: 'E-Book',
                cover: 'https://placehold.co/300x450/1a202c/7a8ba0?text=Moby+Dick',
                path: 'ebook_content/moby_dick.html',
            },
        ];

        // --- STATE ---
        let auth, db, user, userShelf = new Set();
        let progressUnsubscribe = null;
        let shelfUnsubscribe = null;
        let activeBookProgress = {};

        // --- INITIALIZATION ---
        function init() {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setupEventListeners();
            monitorAuthState();
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            document.getElementById('login-button').addEventListener('click', signIn);
            document.getElementById('logout-button').addEventListener('click', signOutUser);
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', handleNavigation);
            });
            document.getElementById('mobile-menu-button').addEventListener('click', toggleMobileMenu);
            document.getElementById('request-form').addEventListener('submit', handleRequestSubmit);
        }

        // --- AUTHENTICATION ---
        function monitorAuthState() {
            onAuthStateChanged(auth, u => {
                if (u) {
                    user = u;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                    document.getElementById('request-email').value = user.email;
                    loadInitialData();
                } else {
                    user = null;
                    document.getElementById('login-screen').classList.remove('hidden');
                    document.getElementById('main-app').classList.add('hidden');
                    if (progressUnsubscribe) progressUnsubscribe();
                    if (shelfUnsubscribe) shelfUnsubscribe();
                }
            });
        }

        function signIn() {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(error => {
                console.error("Authentication Error:", error);
                showToast(`Login failed: ${error.message}`, true);
            });
        }

        function signOutUser() {
            signOut(auth).catch(error => console.error("Sign Out Error:", error));
        }

        // --- DATA HANDLING ---
        function loadInitialData() {
            renderLibrary();
            listenToShelf();
        }

        function listenToShelf() {
            if (shelfUnsubscribe) shelfUnsubscribe();
            const shelfRef = collection(db, 'users', user.uid, 'shelf');
            shelfUnsubscribe = onSnapshot(shelfRef, (snapshot) => {
                userShelf.clear();
                snapshot.forEach(doc => userShelf.add(doc.id));
                renderShelf();
                // Re-render library to update shelf buttons
                renderLibrary();
            }, (error) => console.error("Error listening to shelf:", error));
        }
        
        async function addToShelf(book) {
            try {
                const shelfRef = doc(db, 'users', user.uid, 'shelf', book.id);
                await setDoc(shelfRef, { title: book.title, type: book.type, addedAt: new Date() });
                showToast(`${book.title} added to your shelf!`);
            } catch (error) {
                console.error("Error adding to shelf: ", error);
                showToast("Failed to add to shelf.", true);
            }
        }
        
        async function removeFromShelf(bookId) {
             try {
                const shelfRef = doc(db, 'users', user.uid, 'shelf', bookId);
                await deleteDoc(shelfRef);
                showToast(`Removed from your shelf.`);
            } catch (error) {
                console.error("Error removing from shelf: ", error);
                showToast("Failed to remove from shelf.", true);
            }
        }

        // --- RENDERING ---
        function renderLibrary() {
            const grid = document.getElementById('library-grid');
            grid.innerHTML = libraryCatalog.map(book => createBookCard(book)).join('');
            addBookCardEventListeners();
        }
        
        function renderShelf() {
            const grid = document.getElementById('shelf-grid');
            const emptyMessage = document.getElementById('empty-shelf-message');
            const shelfBooks = libraryCatalog.filter(book => userShelf.has(book.id));
            
            if (shelfBooks.length === 0) {
                grid.innerHTML = '';
                emptyMessage.classList.remove('hidden');
            } else {
                emptyMessage.classList.add('hidden');
                grid.innerHTML = shelfBooks.map(book => createBookCard(book)).join('');
                addBookCardEventListeners();
            }
        }

        function createBookCard(book) {
            const isOnShelf = userShelf.has(book.id);
            const buttonText = isOnShelf ? 'On Shelf' : 'Add to Shelf';
            const buttonClass = isOnShelf ? 'bg-gray-600 cursor-default' : 'bg-indigo-600 hover:bg-indigo-500';

            return `
                <div class="space-y-2">
                    <div class="aspect-[2/3] bg-gray-800 rounded-lg overflow-hidden cursor-pointer book-card" data-book-id="${book.id}">
                        <img src="${book.cover}" alt="${book.title}" class="w-full h-full object-cover">
                    </div>
                    <div class="text-sm">
                        <h3 class="font-semibold truncate">${book.title}</h3>
                        <p class="text-gray-400 truncate">${book.author}</p>
                    </div>
                </div>
            `;
        }
        
        function addBookCardEventListeners() {
            document.querySelectorAll('.book-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const bookId = e.currentTarget.dataset.bookId;
                    const book = libraryCatalog.find(b => b.id === bookId);
                    if (book) showBookDetailsModal(book);
                });
            });
        }
        
        // --- MODALS & OVERLAYS ---
        function showBookDetailsModal(book) {
            const isOnShelf = userShelf.has(book.id);
            const shelfButtonHtml = isOnShelf
                ? `<button data-book-id="${book.id}" class="shelf-remove-btn w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Remove from Shelf</button>`
                : `<button data-book-id="${book.id}" class="shelf-add-btn w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Add to Shelf</button>`;

            const actionButtonHtml = book.type === 'Audiobook'
                ? `<button data-book-id="${book.id}" class="listen-now-btn flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Listen Now</button>`
                : `<button data-book-id="${book.id}" class="read-now-btn flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Read Now</button>`;

            const modalHtml = `
                <div class="modal-overlay" id="details-modal-overlay"></div>
                <div class="modal-content w-11/12 max-w-md bg-gray-800 rounded-xl shadow-lg p-6">
                    <div class="flex flex-col sm:flex-row gap-6">
                        <div class="sm:w-1/3">
                            <img src="${book.cover}" alt="${book.title}" class="w-full h-auto object-cover rounded-md shadow-lg">
                        </div>
                        <div class="sm:w-2/3 flex flex-col">
                            <h2 class="text-2xl font-bold">${book.title}</h2>
                            <p class="text-lg text-gray-400 mb-2">${book.author}</p>
                            <p class="text-sm bg-gray-700 text-indigo-300 self-start px-2 py-1 rounded">${book.type}</p>
                            <div class="mt-auto space-y-3 pt-4">
                               <div class="flex gap-3">
                                  ${actionButtonHtml}
                               </div>
                               ${shelfButtonHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = modalHtml;
            modalContainer.classList.remove('hidden');

            document.getElementById('details-modal-overlay').addEventListener('click', closeModal);
            
            const addBtn = modalContainer.querySelector('.shelf-add-btn');
            if (addBtn) addBtn.addEventListener('click', () => {
                addToShelf(book);
                closeModal();
            });

            const removeBtn = modalContainer.querySelector('.shelf-remove-btn');
            if (removeBtn) removeBtn.addEventListener('click', () => {
                removeFromShelf(book.id);
                closeModal();
            });

            const readBtn = modalContainer.querySelector('.read-now-btn');
            if(readBtn) readBtn.addEventListener('click', () => openEbookReader(book));

            const listenBtn = modalContainer.querySelector('.listen-now-btn');
            if(listenBtn) listenBtn.addEventListener('click', () => openAudioPlayer(book));
        }

        function closeModal() {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.classList.add('hidden');
            modalContainer.innerHTML = '';
        }
        
        // --- E-BOOK READER ---
        async function openEbookReader(book) {
            closeModal();
            const progressRef = doc(db, 'users', user.uid, 'progress', book.id);
            const progressSnap = await getDoc(progressRef);
            const progressData = progressSnap.exists() ? progressSnap.data() : { scrollPosition: 0 };

            // This is a placeholder for fetching book content.
            // In a real app, you would fetch this from your Backblaze bucket.
            // For now, we use a placeholder text.
            const bookContent = `
                <h1 class="text-4xl font-bold mb-4">${book.title}</h1>
                <h2 class="text-2xl text-gray-400 mb-8">${book.author}</h2>
                <p class="text-lg leading-relaxed mb-4">This is where the content for "${book.title}" would be displayed. In a real implementation, this text would be fetched from your file storage. For now, enjoy this placeholder content.</p>
                <p class="text-lg leading-relaxed mb-4">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                 <p class="text-lg leading-relaxed mb-4">Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo. Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt.</p>
                <p class="text-lg leading-relaxed">[... much more content would follow ...]</p>
            `;

            const readerHtml = `
                <div class="modal-overlay"></div>
                <div class="modal-content w-full h-full bg-gray-900 flex flex-col">
                    <header class="flex-shrink-0 bg-gray-800 p-4 flex justify-between items-center shadow-md">
                        <div>
                            <h3 class="text-xl font-bold">${book.title}</h3>
                            <p class="text-sm text-gray-400">${book.author}</p>
                        </div>
                        <button id="close-reader-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg">Close</button>
                    </header>
                    <div id="ebook-content-container" class="ebook-reader-content flex-grow overflow-y-auto p-6 md:p-12 lg:p-16 text-gray-300">
                       ${bookContent}
                    </div>
                </div>
            `;

            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = readerHtml;
            modalContainer.classList.remove('hidden');

            const contentContainer = document.getElementById('ebook-content-container');
            contentContainer.scrollTop = progressData.scrollPosition || 0;

            let scrollTimeout;
            contentContainer.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(async () => {
                    await setDoc(progressRef, { scrollPosition: contentContainer.scrollTop }, { merge: true });
                }, 500); // Debounce saving scroll position
            });

            document.getElementById('close-reader-btn').addEventListener('click', closeModal);
        }

        // --- AUDIO PLAYER ---
        async function openAudioPlayer(book) {
            closeModal();
            const progressRef = doc(db, 'users', user.uid, 'progress', book.id);
            const progressSnap = await getDoc(progressRef);
            const progressData = progressSnap.exists() ? progressSnap.data() : { currentTime: 0 };
            
            const audioSrc = B2_BUCKET_URL + book.path;

            const playerHtml = `
                <div class="modal-overlay" id="audio-player-overlay"></div>
                <div class="modal-content w-11/12 max-w-sm bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col items-center">
                    <img src="${book.cover}" alt="${book.title}" class="w-full aspect-square object-cover rounded-md shadow-lg mb-4">
                    <h3 class="text-xl font-bold text-center">${book.title}</h3>
                    <p class="text-md text-gray-400 mb-4 text-center">${book.author}</p>
                    <audio id="audio-element" controls class="w-full" src="${audioSrc}"></audio>
                    <button id="close-player-btn" class="mt-6 w-full bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg">Close</button>
                </div>
            `;
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = playerHtml;
            modalContainer.classList.remove('hidden');

            const audioElement = document.getElementById('audio-element');
            
            audioElement.addEventListener('canplay', () => {
                audioElement.currentTime = progressData.currentTime || 0;
                audioElement.play();
            });

            let timeUpdateTimeout;
            audioElement.addEventListener('timeupdate', () => {
                clearTimeout(timeUpdateTimeout);
                timeUpdateTimeout = setTimeout(async () => {
                    if (!audioElement.paused) {
                        await setDoc(progressRef, { currentTime: audioElement.currentTime }, { merge: true });
                    }
                }, 1000); // Debounce saving time
            });

            document.getElementById('close-player-btn').addEventListener('click', closeModal);
            document.getElementById('audio-player-overlay').addEventListener('click', closeModal);
        }

        // --- NAVIGATION & UI ---
        function handleNavigation(e) {
            e.preventDefault();
            const page = e.target.dataset.page;

            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(`${page}-page`).classList.remove('hidden');

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('bg-gray-900', 'text-white');
                link.classList.add('text-gray-300', 'hover:bg-gray-700');
            });

            e.target.classList.add('bg-gray-900', 'text-white');
            e.target.classList.remove('text-gray-300', 'hover:bg-gray-700');
            
            // Close mobile menu on navigation
            const mobileMenu = document.getElementById('mobile-menu');
            if(!mobileMenu.classList.contains('hidden')) {
                toggleMobileMenu();
            }
        }
        
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const button = document.getElementById('mobile-menu-button');
            const icons = button.querySelectorAll('svg');
            menu.classList.toggle('hidden');
            icons[0].classList.toggle('hidden');
            icons[1].classList.toggle('hidden');
        }

        // --- REQUEST FORM ---
        async function handleRequestSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const request = {
                userEmail: form.elements['request-email'].value,
                title: form.elements['request-title'].value,
                author: form.elements['request-author'].value,
                type: form.elements['request-type'].value,
                status: 'pending',
                submittedAt: new Date(),
                userId: user.uid
            };
            
            try {
                await addDoc(collection(db, 'requests'), request);
                showToast("Request submitted successfully!");
                form.reset();
                document.getElementById('request-email').value = user.email; // repopulate email
            } catch (error) {
                console.error("Error submitting request:", error);
                showToast("Failed to submit request.", true);
            }
        }

        // --- UTILITIES ---
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-container');
            toast.textContent = message;
            toast.className = 'toast show';
            toast.style.backgroundColor = isError ? '#e74c3c' : '#2ecc71';

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // --- START ---
        init();

    </script>
</body>
</html>
